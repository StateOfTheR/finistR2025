<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="fr" xml:lang="fr"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Caroline Cognot">
<meta name="author" content="Jeanne Tous">
<meta name="author" content="Blanche Francheterre">

<title>Animint 2 – Finist’R 2025</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-b8ded578f01cf45f867b749dfb801973.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "Pas de résultats",
    "search-matching-documents-text": "documents trouvés",
    "search-copy-link-title": "Copier le lien vers la recherche",
    "search-hide-matches-text": "Cacher les correspondances additionnelles",
    "search-more-match-text": "correspondance de plus dans ce document",
    "search-more-matches-text": "correspondances de plus dans ce document",
    "search-clear-button-title": "Effacer",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Annuler",
    "search-submit-button-title": "Envoyer",
    "search-label": "Recherche"
  }
}</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Finist’R 2025</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Recherche"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Basculer la navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/StateOfTheR/finistR2025"> <i class="bi bi-github" role="img" aria-label="GitHub">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./instructions.html"> 
<span class="menu-text">Instructions</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-développement" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Développement</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-développement">    
        <li>
    <a class="dropdown-item" href="./how_to_build_your_package.html">
 <span class="dropdown-text">How to build your package - Julia edition</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./positron.qmd">
 <span class="dropdown-text">Positron</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="./autodiff.html"> 
<span class="menu-text">Différentiation automatique</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="./animint.html" aria-current="page"> 
<span class="menu-text">animint2</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./hsmc.qmd"> 
<span class="menu-text">HMSC</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./traccar.html"> <i class="bi bi-Bicycle" role="img">
</i> 
<span class="menu-text">GPS – traccar</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./sparse_cholesky.html"> 
<span class="menu-text">Sparse Cholesky</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./how_to_build_your_package.html"> 
<span class="menu-text">How to build your package - Julia edition</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Sur cette page</h2>
   
  <ul>
  <li><a href="#loading-useful-libraries" id="toc-loading-useful-libraries" class="nav-link active" data-scroll-target="#loading-useful-libraries">Loading useful libraries</a></li>
  <li><a href="#example-1-world-bank-data" id="toc-example-1-world-bank-data" class="nav-link" data-scroll-target="#example-1-world-bank-data">EXAMPLE 1: World Bank data</a>
  <ul class="collapse">
  <li><a href="#data-loading-and-formatting" id="toc-data-loading-and-formatting" class="nav-link" data-scroll-target="#data-loading-and-formatting">Data loading and formatting</a></li>
  <li><a href="#first-animint-plot-show-life-expectancy-for-each-country-over-time" id="toc-first-animint-plot-show-life-expectancy-for-each-country-over-time" class="nav-link" data-scroll-target="#first-animint-plot-show-life-expectancy-for-each-country-over-time">First animint plot: show life expectancy for each country over time</a></li>
  <li><a href="#adding-a-bar-to-highlights-a-year" id="toc-adding-a-bar-to-highlights-a-year" class="nav-link" data-scroll-target="#adding-a-bar-to-highlights-a-year">Adding a bar to highlights a year</a></li>
  <li><a href="#modify-the-vertical-cursor-text-display-to-show-the-average-life-expectancy" id="toc-modify-the-vertical-cursor-text-display-to-show-the-average-life-expectancy" class="nav-link" data-scroll-target="#modify-the-vertical-cursor-text-display-to-show-the-average-life-expectancy">Modify the vertical cursor text display to show the average life expectancy</a></li>
  <li><a href="#add-points-to-get-exact-value-of-life-expectancy-for-each-country" id="toc-add-points-to-get-exact-value-of-life-expectancy-for-each-country" class="nav-link" data-scroll-target="#add-points-to-get-exact-value-of-life-expectancy-for-each-country">Add points to get exact value of life expectancy for each country</a></li>
  <li><a href="#let-us-add-a-second-facet" id="toc-let-us-add-a-second-facet" class="nav-link" data-scroll-target="#let-us-add-a-second-facet">Let us add a second facet</a></li>
  </ul></li>
  <li><a href="#example-2-us-tornadoes-visualization" id="toc-example-2-us-tornadoes-visualization" class="nav-link" data-scroll-target="#example-2-us-tornadoes-visualization">EXAMPLE 2: US tornadoes visualization</a>
  <ul class="collapse">
  <li><a href="#generating-a-us-map" id="toc-generating-a-us-map" class="nav-link" data-scroll-target="#generating-a-us-map">Generating a US map</a></li>
  <li><a href="#adding-the-tornadoes-segments" id="toc-adding-the-tornadoes-segments" class="nav-link" data-scroll-target="#adding-the-tornadoes-segments">Adding the tornadoes segments</a></li>
  <li><a href="#adding-the-tornadoes-points" id="toc-adding-the-tornadoes-points" class="nav-link" data-scroll-target="#adding-the-tornadoes-points">Adding the tornadoes points</a></li>
  <li><a href="#creating-histograms-with-the-number-of-tornadoes-per-state-year" id="toc-creating-histograms-with-the-number-of-tornadoes-per-state-year" class="nav-link" data-scroll-target="#creating-histograms-with-the-number-of-tornadoes-per-state-year">Creating histograms with the number of tornadoes per (state, year)</a></li>
  <li><a href="#combining-the-map-and-histogram" id="toc-combining-the-map-and-histogram" class="nav-link" data-scroll-target="#combining-the-map-and-histogram">Combining the map and histogram</a></li>
  </ul></li>
  <li><a href="#example-3-temperature-data" id="toc-example-3-temperature-data" class="nav-link" data-scroll-target="#example-3-temperature-data">EXAMPLE 3 : TEMPERATURE DATA</a>
  <ul class="collapse">
  <li><a href="#get-the-data-to-plot" id="toc-get-the-data-to-plot" class="nav-link" data-scroll-target="#get-the-data-to-plot">Get the data to plot</a></li>
  <li><a href="#objective-number-1-getting-percentage-fyear-with-colorquantile-selecting-only-chosen-year-and-highlighting-only-chosen-quantile." id="toc-objective-number-1-getting-percentage-fyear-with-colorquantile-selecting-only-chosen-year-and-highlighting-only-chosen-quantile." class="nav-link" data-scroll-target="#objective-number-1-getting-percentage-fyear-with-colorquantile-selecting-only-chosen-year-and-highlighting-only-chosen-quantile.">Objective number 1 : getting percentage = f(year) with color=quantile , selecting only chosen year and highlighting only chosen quantile.</a></li>
  <li><a href="#objective-2-plot-the-temperature-for-chosen-day-t-of-a-given-year" id="toc-objective-2-plot-the-temperature-for-chosen-day-t-of-a-given-year" class="nav-link" data-scroll-target="#objective-2-plot-the-temperature-for-chosen-day-t-of-a-given-year">Objective 2 : plot the temperature for chosen day t of a given year</a></li>
  <li><a href="#objective-3-plot-together-the-map-of-temperature-at-a-day-highlighting-that-day-on-my-first-plot" id="toc-objective-3-plot-together-the-map-of-temperature-at-a-day-highlighting-that-day-on-my-first-plot" class="nav-link" data-scroll-target="#objective-3-plot-together-the-map-of-temperature-at-a-day-highlighting-that-day-on-my-first-plot">Objective 3 : plot together the map of temperature at a day, highlighting that day on my first plot</a></li>
  <li><a href="#objective-4-show-maps-at-different-time-steps-t-1-t-and-t1-to-show-temporal-evolution" id="toc-objective-4-show-maps-at-different-time-steps-t-1-t-and-t1-to-show-temporal-evolution" class="nav-link" data-scroll-target="#objective-4-show-maps-at-different-time-steps-t-1-t-and-t1-to-show-temporal-evolution">Objective 4 : Show maps at different time steps : t-1, t and t+1, to show temporal evolution</a></li>
  <li><a href="#final-objective" id="toc-final-objective" class="nav-link" data-scroll-target="#final-objective">Final objective</a></li>
  <li><a href="#final-final-objective-add-facets-to-make-it-pretty" id="toc-final-final-objective-add-facets-to-make-it-pretty" class="nav-link" data-scroll-target="#final-final-objective-add-facets-to-make-it-pretty">Final Final Objective : add facets to make it pretty</a></li>
  </ul></li>
  <li><a href="#saving-your-work" id="toc-saving-your-work" class="nav-link" data-scroll-target="#saving-your-work">SAVING YOUR WORK</a>
  <ul class="collapse">
  <li><a href="#option-1-in-rmd-and-qmd" id="toc-option-1-in-rmd-and-qmd" class="nav-link" data-scroll-target="#option-1-in-rmd-and-qmd">Option 1: in rmd and qmd</a></li>
  <li><a href="#option-2-html" id="toc-option-2-html" class="nav-link" data-scroll-target="#option-2-html">Option 2: html</a></li>
  <li><a href="#section" id="toc-section" class="nav-link" data-scroll-target="#section"></a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Animint 2</h1>
</div>


<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Auteur·rice·s</div>
  <div class="quarto-title-meta-heading">Affiliation</div>
  
    <div class="quarto-title-meta-contents">
    <p class="author">Caroline Cognot </p>
  </div>
  <div class="quarto-title-meta-contents">
      </div>
    <div class="quarto-title-meta-contents">
    <p class="author">Jeanne Tous </p>
  </div>
  <div class="quarto-title-meta-contents">
      </div>
    <div class="quarto-title-meta-contents">
    <p class="author">Blanche Francheterre </p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            INRAE - MIA Paris Saclay
          </p>
      </div>
  </div>

<div class="quarto-title-meta">

      
    <div>
    <div class="quarto-title-meta-heading">Date de publication</div>
    <div class="quarto-title-meta-contents">
      <p class="date">18 août 2025</p>
    </div>
  </div>
  
    <div>
    <div class="quarto-title-meta-heading">Modifié</div>
    <div class="quarto-title-meta-contents">
      <p class="date-modified">22 août 2025</p>
    </div>
  </div>
    
  </div>
  


</header>


<p>We follow a simplified version of the tutorial given here: https://rcdata.nau.edu/genomic-ml/animint2-manual/Ch08-WorldBank-facets.html</p>
<section id="loading-useful-libraries" class="level1">
<h1>Loading useful libraries</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">suppressPackageStartupMessages</span>(<span class="fu">library</span>(animint2))</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">suppressPackageStartupMessages</span>(<span class="fu">library</span>(data.table))</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">suppressPackageStartupMessages</span>(<span class="fu">library</span>(dplyr))</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">suppressPackageStartupMessages</span>(<span class="fu">library</span>(plyr))</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">suppressPackageStartupMessages</span>(<span class="fu">library</span>(maps))</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="example-1-world-bank-data" class="level1">
<h1>EXAMPLE 1: World Bank data</h1>
<section id="data-loading-and-formatting" class="level2">
<h2 class="anchored" data-anchor-id="data-loading-and-formatting">Data loading and formatting</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(WorldBank)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>WorldBank<span class="sc">$</span>Region <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">" (all income levels)"</span>, <span class="st">""</span>, WorldBank<span class="sc">$</span>region, <span class="at">fixed=</span><span class="cn">TRUE</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove NAs</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">data.table</span>(WorldBank)[<span class="sc">!</span>(<span class="fu">is.na</span>(life.expectancy) <span class="sc">|</span> <span class="fu">is.na</span>(fertility.rate))] </span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Display only the region south asia for ease of vizualization</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df[df<span class="sc">$</span>region <span class="sc">==</span> <span class="st">"South Asia"</span>]</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>years <span class="ot">&lt;-</span> <span class="fu">unique</span>(df[, .(year)])</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The helper functions FACETS etc will be used to generate adequate facet grids.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>add_facets <span class="ot">&lt;-</span> <span class="cf">function</span>(df, top, side){</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(df,</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>             <span class="at">top=</span><span class="fu">factor</span>(top, <span class="fu">c</span>(<span class="st">"Fertility rate"</span>, <span class="st">"Years"</span>)),</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>             <span class="at">side=</span><span class="fu">factor</span>(side, <span class="fu">c</span>(<span class="st">"Years"</span>, <span class="st">"Life expectancy"</span>)))</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>facet_right <span class="ot">&lt;-</span> <span class="cf">function</span>(df) <span class="fu">add_facets</span>(df, <span class="st">"Years"</span>, <span class="st">"Life expectancy"</span>)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>facet_left  <span class="ot">&lt;-</span> <span class="cf">function</span>(df) <span class="fu">add_facets</span>(df, <span class="st">"Fertility rate"</span>, <span class="st">"Life expectancy"</span>)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="first-animint-plot-show-life-expectancy-for-each-country-over-time" class="level2">
<h2 class="anchored" data-anchor-id="first-animint-plot-show-life-expectancy-for-each-country-over-time">First animint plot: show life expectancy for each country over time</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>life_expect_plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>()<span class="sc">+</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">geom_line</span>(<span class="fu">aes</span>(year, life.expectancy,</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">group =</span> country, <span class="at">colour =</span> country),</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">clickSelects =</span> <span class="st">"country"</span>, <span class="at">data =</span> <span class="fu">facet_right</span>(df),</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">size =</span> <span class="dv">4</span>, <span class="at">alpha =</span> <span class="dv">3</span><span class="sc">/</span><span class="dv">5</span>)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>life_expect_plot</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="animint_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>With animint, the plot is shown in the “Viewer” panel and one can select which countries should be left in the plot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">animint</span>(life_expect_plot)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<script type="text/javascript" src="unnamedchunk5/vendor/d3.v3.js"></script>
<script type="text/javascript" src="unnamedchunk5/animint.js"></script>
<script type="text/javascript" src="unnamedchunk5/vendor/jquery-1.11.3.min.js"></script>
<script type="text/javascript" src="unnamedchunk5/vendor/selectize.min.js"></script>
<link rel="stylesheet" type="text/css" href="unnamedchunk5/vendor/selectize.css">
<script type="text/javascript" src="unnamedchunk5/vendor/driver.js.iife.js"></script>
<link rel="stylesheet" href="unnamedchunk5/vendor/driver.css">
<p>
</p>
<div id="unnamedchunk5">

</div>
<script>var unnamedchunk5 = new animint("#unnamedchunk5", "unnamedchunk5/plot.json");</script>
</div>
</div>
</section>
<section id="adding-a-bar-to-highlights-a-year" class="level2">
<h2 class="anchored" data-anchor-id="adding-a-bar-to-highlights-a-year">Adding a bar to highlights a year</h2>
<p>The important parameter here is ‘clickSelects’.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># facet_right(years) contains the unique years of the df and 2 columns for facet used later in the tutorial</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>plot_with_bar <span class="ot">&lt;-</span> life_expect_plot <span class="sc">+</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">geom_tallrect</span>(<span class="fu">aes</span>(<span class="at">xmin =</span> year<span class="dv">-1</span><span class="sc">/</span><span class="dv">2</span>, <span class="at">xmax =</span> year<span class="sc">+</span><span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>),</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>                               <span class="at">clickSelects=</span><span class="st">"year"</span>, <span class="at">data =</span> <span class="fu">facet_right</span>(years),</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>                               <span class="at">alpha=</span><span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>, <span class="at">show.legend =</span> T)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="fu">animint</span>(plot_with_bar)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p></p>
<div id="unnamedchunk6"></div>
<script>var unnamedchunk6 = new animint("#unnamedchunk6", "unnamedchunk6/plot.json");</script>
</div>
</div>
</section>
<section id="modify-the-vertical-cursor-text-display-to-show-the-average-life-expectancy" class="level2">
<h2 class="anchored" data-anchor-id="modify-the-vertical-cursor-text-display-to-show-the-average-life-expectancy">Modify the vertical cursor text display to show the average life expectancy</h2>
<p>By default, the text displayed at the current state of the bar is the current value of the bar. Use the ‘toolkit’ argument in aes() to change what is displayed.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>years_df <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(year) <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">mean_life_expectancy =</span> <span class="fu">mean</span>(life.expectancy))</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>plot_with_bar <span class="ot">&lt;-</span> life_expect_plot <span class="sc">+</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">geom_tallrect</span>(<span class="fu">aes</span>(<span class="at">xmin=</span>year<span class="dv">-1</span><span class="sc">/</span><span class="dv">2</span>, <span class="at">xmax=</span>year<span class="sc">+</span><span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">tooltip =</span> <span class="fu">paste0</span>(<span class="st">"Mean life expectancy: "</span>,</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>                                                           <span class="fu">round</span>(mean_life_expectancy, <span class="dv">1</span>))),</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">clickSelects=</span><span class="st">"year"</span>,</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">data =</span> <span class="fu">facet_right</span>(years_df), <span class="at">alpha=</span><span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>) </span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="fu">animint</span>(plot_with_bar)  </span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p></p>
<div id="unnamedchunk7"></div>
<script>var unnamedchunk7 = new animint("#unnamedchunk7", "unnamedchunk7/plot.json");</script>
</div>
</div>
</section>
<section id="add-points-to-get-exact-value-of-life-expectancy-for-each-country" class="level2">
<h2 class="anchored" data-anchor-id="add-points-to-get-exact-value-of-life-expectancy-for-each-country">Add points to get exact value of life expectancy for each country</h2>
<p>Like the bar above, we use the ‘tooltip’ argument</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>full_plot <span class="ot">&lt;-</span> plot_with_bar <span class="sc">+</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">geom_point</span>(<span class="fu">aes</span>(year, life.expectancy, <span class="at">color =</span> country,</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">tooltip =</span> <span class="fu">paste0</span>(country, <span class="st">" - Life expectancy :"</span>,</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>                                                 <span class="fu">round</span>(life.expectancy, <span class="dv">1</span>))),</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">showSelected =</span> <span class="st">"country"</span>,</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">clickSelects =</span> <span class="st">"country"</span>,</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>                               <span class="at">size =</span> <span class="dv">2</span>,</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>                               <span class="at">data =</span> <span class="fu">facet_right</span>(df)) </span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="fu">animint</span>(full_plot)  </span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p></p>
<div id="unnamedchunk8"></div>
<script>var unnamedchunk8 = new animint("#unnamedchunk8", "unnamedchunk8/plot.json");</script>
</div>
</div>
</section>
<section id="let-us-add-a-second-facet" class="level2">
<h2 class="anchored" data-anchor-id="let-us-add-a-second-facet">Let us add a second facet</h2>
<p>In this part, this is where the functions facet_right and facet_left are useful. These functions creates columns to order the axis. Like ggplot, the variable used for facet must be a factor.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># First add the facet grid</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>plot_right <span class="ot">&lt;-</span> full_plot <span class="sc">+</span> <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>                <span class="fu">theme</span>(<span class="at">panel.margin=</span>grid<span class="sc">::</span><span class="fu">unit</span>(<span class="dv">0</span>, <span class="st">"lines"</span>)) <span class="sc">+</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>                <span class="fu">facet_grid</span>(side <span class="sc">~</span> top, <span class="at">scales=</span><span class="st">"free"</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">""</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>                <span class="fu">theme_animint</span>(<span class="at">width=</span><span class="dv">600</span>)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>When adding the second plot, we use the ‘showSelected’ argument, the variable must correspond to the one used in the first plot with the argument ‘clickSelected’</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the 2nd plot</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>plot_both <span class="ot">&lt;-</span> plot_right <span class="sc">+</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(fertility.rate, life.expectancy,</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>                <span class="at">colour=</span>country, <span class="at">size=</span>population, <span class="at">key=</span>country),</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">clickSelects=</span><span class="st">"country"</span>,</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">showSelected =</span> <span class="st">"year"</span>,</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">data =</span> <span class="fu">facet_left</span>(df)) <span class="sc">+</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">scale_size_animint</span>(<span class="at">pixel.range=</span><span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">20</span>), <span class="at">breaks=</span><span class="dv">10</span><span class="sc">^</span>(<span class="dv">9</span><span class="sc">:</span><span class="dv">5</span>))</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">animint</span>(plot_both)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p></p>
<div id="unnamedchunk11"></div>
<script>var unnamedchunk11 = new animint("#unnamedchunk11", "unnamedchunk11/plot.json");</script>
</div>
</div>
</section>
</section>
<section id="example-2-us-tornadoes-visualization" class="level1">
<h1>EXAMPLE 2: US tornadoes visualization</h1>
<p>Example taken from https://suhaani-agarwal.github.io/tornado-visualization/ ## Loading and formatting data</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(UStornadoes)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>UStornadoes <span class="ot">&lt;-</span> UStornadoes[<span class="fu">order</span>(UStornadoes<span class="sc">$</span>year),] <span class="co"># sort the df by year so that they appear in the right order</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>UStornadoes<span class="sc">$</span>region <span class="ot">&lt;-</span> <span class="fu">tolower</span>(state.name[<span class="fu">match</span>(UStornadoes<span class="sc">$</span>state, state.abb)])</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="generating-a-us-map" class="level2">
<h2 class="anchored" data-anchor-id="generating-a-us-map">Generating a US map</h2>
<p>We first generate an animint map of the US on which each state can be selected</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>USpolygons <span class="ot">&lt;-</span> <span class="fu">map_data</span>(<span class="st">"state"</span>) <span class="co"># Animint function to create a map, "state" is for US states</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>map <span class="ot">=</span> <span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme_animint</span>(<span class="at">width=</span><span class="dv">750</span>, <span class="at">height=</span><span class="dv">500</span>) <span class="sc">+</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_polygon</span>(<span class="fu">aes</span>(<span class="at">x=</span>long, <span class="at">y=</span>lat, <span class="at">group=</span>group, <span class="at">tooltip =</span> region),</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>                   <span class="at">clickSelects=</span><span class="st">"region"</span>,</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>                   <span class="at">data=</span>USpolygons, </span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>                   <span class="at">fill=</span><span class="st">"#000000"</span>,</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>                   <span class="at">colour=</span><span class="st">"white"</span>, </span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>                   <span class="at">size=</span><span class="fl">0.5</span>, </span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>                  <span class="at">alpha=</span><span class="dv">1</span>)</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="fu">animint</span>(map)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p></p>
<div id="unnamedchunk13"></div>
<script>var unnamedchunk13 = new animint("#unnamedchunk13", "unnamedchunk13/plot.json");</script>
</div>
</div>
</section>
<section id="adding-the-tornadoes-segments" class="level2">
<h2 class="anchored" data-anchor-id="adding-the-tornadoes-segments">Adding the tornadoes segments</h2>
<p>Let us add to the maps segments that give the tornadoes trajectory (segment from start point to end point). We also use the parameter ‘showSelected’ so the the map displays the tornado only for a specific year.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>seg.color <span class="ot">&lt;-</span> <span class="st">"#55B1F7"</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>tornadoes_map <span class="ot">&lt;-</span> map <span class="sc">+</span> </span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">geom_segment</span>(<span class="fu">aes</span>(<span class="at">x=</span>startLong, <span class="at">y=</span>startLat,</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">xend=</span>endLong, <span class="at">yend=</span>endLat),</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>                              <span class="at">colour=</span>seg.color, <span class="at">size =</span> <span class="fl">1.2</span>,</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>                              <span class="at">showSelected=</span><span class="st">"year"</span>,</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>                              <span class="at">data=</span>UStornadoes) </span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="fu">animint</span>(tornadoes_map)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p></p>
<div id="unnamedchunk14"></div>
<script>var unnamedchunk14 = new animint("#unnamedchunk14", "unnamedchunk14/plot.json");</script>
</div>
</div>
</section>
<section id="adding-the-tornadoes-points" class="level2">
<h2 class="anchored" data-anchor-id="adding-the-tornadoes-points">Adding the tornadoes points</h2>
<p>Superposing tornadoes end point to tornadoes segments.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>pt.color <span class="ot">&lt;-</span> <span class="st">"#9999F9"</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>tornadoes_map <span class="ot">&lt;-</span> tornadoes_map <span class="sc">+</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">geom_point</span>(<span class="fu">aes</span>(endLong, endLat),               </span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>                             <span class="at">colour=</span>pt.color, </span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>                             <span class="at">showSelected=</span><span class="st">"year"</span>,</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>                             <span class="at">data=</span>UStornadoes,</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>                             <span class="at">size=</span><span class="dv">1</span>)</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="fu">animint</span>(tornadoes_map)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p></p>
<div id="unnamedchunk15"></div>
<script>var unnamedchunk15 = new animint("#unnamedchunk15", "unnamedchunk15/plot.json");</script>
</div>
</div>
</section>
<section id="creating-histograms-with-the-number-of-tornadoes-per-state-year" class="level2">
<h2 class="anchored" data-anchor-id="creating-histograms-with-the-number-of-tornadoes-per-state-year">Creating histograms with the number of tornadoes per (state, year)</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>UStornadoCounts <span class="ot">&lt;-</span> <span class="fu">ddply</span>(UStornadoes, .(region, year), summarize, <span class="at">count=</span><span class="fu">length</span>(region))</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The tornadoes histogram per (state, year). We use the parameter ‘showSelected’ = region so that it can be linked to the map later. Similarly for the argument ‘clickSelects’ = year, it corresponds to ‘showSelected’ in the map.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>tornadoes_hist <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">xlab</span>(<span class="st">"year"</span>) <span class="sc">+</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">ylab</span>(<span class="st">"Number of tornadoes"</span>) <span class="sc">+</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">geom_bar</span>(<span class="fu">aes</span>(year, count),</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>                          <span class="at">clickSelects=</span><span class="st">"year"</span>, </span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>                          <span class="at">showSelected=</span><span class="st">"region"</span>,</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>                          <span class="at">data=</span>UStornadoCounts, </span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>                          <span class="at">stat=</span><span class="st">"identity"</span>, </span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>                          <span class="at">color =</span> <span class="st">"black"</span>,</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>                          <span class="at">fill =</span> <span class="st">"#22212100"</span>,</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>                          <span class="at">alpha =</span> <span class="dv">1</span>,</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>                          <span class="at">position=</span><span class="st">"identity"</span>)</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a><span class="fu">animint</span>(tornadoes_hist)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p></p>
<div id="unnamedchunk17"></div>
<script>var unnamedchunk17 = new animint("#unnamedchunk17", "unnamedchunk17/plot.json");</script>
</div>
</div>
<p>Adding value on top of the bar when it is clicked.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>tornadoes_hist <span class="ot">&lt;-</span> tornadoes_hist <span class="sc">+</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">geom_text</span>(<span class="fu">aes</span>(year, count <span class="sc">+</span> <span class="dv">5</span>, <span class="at">label=</span>count),</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>                             <span class="at">showSelected=</span><span class="fu">c</span>(<span class="st">"region"</span>, <span class="st">"year"</span>),</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>                             <span class="at">data=</span>UStornadoCounts, <span class="at">size=</span><span class="dv">20</span>)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="fu">animint</span>(tornadoes_hist)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p></p>
<div id="unnamedchunk18"></div>
<script>var unnamedchunk18 = new animint("#unnamedchunk18", "unnamedchunk18/plot.json");</script>
</div>
</div>
</section>
<section id="combining-the-map-and-histogram" class="level2">
<h2 class="anchored" data-anchor-id="combining-the-map-and-histogram">Combining the map and histogram</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">animint</span>(tornadoes_map, tornadoes_hist)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p></p>
<div id="unnamedchunk19"></div>
<script>var unnamedchunk19 = new animint("#unnamedchunk19", "unnamedchunk19/plot.json");</script>
</div>
</div>
</section>
</section>
<section id="example-3-temperature-data" class="level1">
<h1>EXAMPLE 3 : TEMPERATURE DATA</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(animint2)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(terra)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>terra 1.8.60</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'terra'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:data.table':

    shift</code></pre>
</div>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'tidyr'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:terra':

    extract</code></pre>
</div>
</div>
<section id="get-the-data-to-plot" class="level2">
<h2 class="anchored" data-anchor-id="get-the-data-to-plot">Get the data to plot</h2>
<p>First, let us get the data and usefull functions</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>france_temperature<span class="ot">=</span><span class="fu">rast</span>(<span class="st">"data/EOBS_FR31.nc"</span>)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'lubridate'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:terra':

    intersect, union</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:data.table':

    hour, isoweek, mday, minute, month, quarter, second, wday, week,
    yday, year</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:base':

    date, intersect, setdiff, union</code></pre>
</div>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>dates <span class="ot">=</span> <span class="fu">seq.Date</span>(<span class="fu">ymd</span>(<span class="st">"1985-01-01"</span>),<span class="fu">ymd</span>(<span class="st">"2015-12-31"</span>),<span class="at">by=</span><span class="st">'day'</span>)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>dates <span class="ot">=</span> dates[</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fu">which</span>((<span class="fu">month</span>(dates)<span class="sc">==</span><span class="dv">2</span> <span class="sc">&amp;</span> <span class="fu">day</span>(dates)<span class="sc">==</span><span class="dv">29</span>))]</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>france_temperature <span class="ot">=</span> france_temperature[[<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(dates)]]</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>datessummers <span class="ot">=</span> dates[(<span class="fu">month</span>(dates)<span class="sc">%in%</span><span class="dv">6</span><span class="sc">:</span><span class="dv">8</span>) <span class="sc">&amp;</span> ( <span class="fu">year</span>(dates) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">2003</span>,<span class="dv">2015</span>,<span class="dv">1990</span>,<span class="dv">1999</span>)) ]</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>summers <span class="ot">=</span><span class="fu">subset</span>(france_temperature, <span class="fu">month</span>(<span class="fu">time</span>(france_temperature)) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">6</span>,<span class="dv">7</span>,<span class="dv">8</span>))</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>summers <span class="ot">=</span><span class="fu">subset</span>(summers, <span class="fu">year</span>(<span class="fu">time</span>(summers)) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">2003</span>,<span class="dv">2015</span>,<span class="dv">1990</span>,<span class="dv">1999</span>))</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(summers)<span class="ot">=</span>datessummers</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a><span class="do">## function to get quantile map ----</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>get_qmap<span class="ot">=</span><span class="cf">function</span>(raster,li_q){</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>  n<span class="ot">=</span><span class="fu">length</span>(li_q)</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>  s <span class="ot">=</span> <span class="fu">c</span>()</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n){</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>    q<span class="ot">=</span>li_q[i]</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>    s <span class="ot">&lt;-</span><span class="fu">c</span>(s,<span class="fu">app</span>(raster, <span class="at">fun=</span><span class="cf">function</span>(i){<span class="fu">quantile</span>(i,q,<span class="at">na.rm=</span>T)}))</span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>  s<span class="ot">=</span><span class="fu">rast</span>(s)</span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(s) <span class="ot">=</span> li_q</span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(s)</span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a><span class="do">## get quantile maps from observation 1985-2015-------</span></span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>qmaps <span class="ot">=</span> (<span class="fu">get_qmap</span>(summers,<span class="fu">c</span>(<span class="fl">0.9</span>,<span class="fl">0.95</span>,<span class="fl">0.98</span>,<span class="fl">0.99</span>)))</span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(qmaps)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="animint_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The different maps are quantiles of temperature for each pixels.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="do">## function to get percentage of area over quantiles ----</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>get_area_over_qmaps<span class="ot">=</span><span class="cf">function</span>(raster,qmaps){</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">#returns a time dataframe of % of area over the maps in qmaps</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># n+1 columns with n the number of layers in qmaps, named after quantiles.</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>  ngrid <span class="ot">=</span> <span class="fu">global</span>((<span class="fu">not.na</span>(raster)),sum)</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>  depsummer <span class="ot">=</span><span class="fu">data.frame</span>(<span class="at">t=</span><span class="fu">time</span>(raster))</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nlyr</span>(qmaps)){</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>    qmap <span class="ot">=</span> qmaps[[i]]</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>    summersq <span class="ot">=</span> raster<span class="sc">&gt;</span>qmap</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>    depsummer[,i<span class="sc">+</span><span class="dv">1</span>]<span class="ot">=</span> <span class="fu">global</span>(summersq,sum,<span class="at">na.rm=</span>T)<span class="sc">/</span>ngrid</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(depsummer)<span class="ot">=</span><span class="fu">c</span>(<span class="st">'t'</span>,<span class="fu">names</span>(qmaps))</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(depsummer)</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>data<span class="ot">=</span><span class="fu">get_area_over_qmaps</span>(summers,qmaps)</span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>depsummer<span class="ot">=</span>data</span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>longdep<span class="ot">=</span><span class="fu">gather</span>(depsummer,quantile,percentage,<span class="sc">-</span>t)</span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>longdep<span class="sc">$</span>year <span class="ot">=</span><span class="fu">year</span>(longdep<span class="sc">$</span>t)</span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>longdep<span class="sc">$</span>day_of_year<span class="ot">=</span><span class="fu">yday</span>(longdep<span class="sc">$</span>t)</span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(depsummer)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           t 0.9 0.95 0.98 0.99
1 1990-06-01   0    0    0    0
2 1990-06-02   0    0    0    0
3 1990-06-03   0    0    0    0
4 1990-06-04   0    0    0    0
5 1990-06-05   0    0    0    0
6 1990-06-06   0    0    0    0</code></pre>
</div>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(longdep)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           t quantile percentage year day_of_year
1 1990-06-01      0.9          0 1990         152
2 1990-06-02      0.9          0 1990         153
3 1990-06-03      0.9          0 1990         154
4 1990-06-04      0.9          0 1990         155
5 1990-06-05      0.9          0 1990         156
6 1990-06-06      0.9          0 1990         157</code></pre>
</div>
</div>
<p>longdep contains for each date t, each quantile, each year and day_of_year the percentage of location over their quantile.</p>
</section>
<section id="objective-number-1-getting-percentage-fyear-with-colorquantile-selecting-only-chosen-year-and-highlighting-only-chosen-quantile." class="level2">
<h2 class="anchored" data-anchor-id="objective-number-1-getting-percentage-fyear-with-colorquantile-selecting-only-chosen-year-and-highlighting-only-chosen-quantile.">Objective number 1 : getting percentage = f(year) with color=quantile , selecting only chosen year and highlighting only chosen quantile.</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(animint2)</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>gobs <span class="ot">&lt;-</span> animint2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>  animint2<span class="sc">::</span><span class="fu">geom_line</span>(</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>   animint2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x=</span>day_of_year, <span class="at">y=</span> percentage,<span class="at">group =</span> <span class="fu">interaction</span>(quantile,year),<span class="at">color=</span>quantile), <span class="at">data =</span> longdep</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>  animint2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"some summers - proportion of FR map exceeding given quantile - observations"</span>)</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>gobs</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="animint_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This is not very pretty ! There is too much info at once. We want to only plot a given year, selected using showSelected=c( “year”). And also, why not choosing the quantiles to plot ?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>plot_QER <span class="ot">&lt;-</span> animint2<span class="sc">::</span><span class="fu">ggplot</span>()<span class="sc">+</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a> animint2<span class="sc">::</span><span class="fu">geom_line</span>(animint2<span class="sc">::</span><span class="fu">aes</span>(</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>    day_of_year,percentage,<span class="at">group=</span>quantile,<span class="at">color=</span>quantile),</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">clickSelects=</span><span class="fu">c</span>(<span class="st">"year"</span>,<span class="st">"quantile"</span>), <span class="co">#use selection to choose the year.</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>     <span class="at">showSelected=</span><span class="fu">c</span>( <span class="st">"year"</span>), <span class="co">#only show the selected year</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">data=</span>(longdep), <span class="at">size=</span><span class="dv">4</span>, <span class="at">alpha=</span><span class="dv">3</span><span class="sc">/</span><span class="dv">5</span>)<span class="sc">+</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Day of year"</span>)<span class="sc">+</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Percentage"</span>)</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a><span class="fu">animint</span>(plot_QER)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p></p>
<div id="unnamedchunk24"></div>
<script>var unnamedchunk24 = new animint("#unnamedchunk24", "unnamedchunk24/plot.json");</script>
</div>
</div>
<p>We can add a rectangle, higlighting a selected day (will be useful later)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>plot_QER <span class="ot">&lt;-</span> animint2<span class="sc">::</span><span class="fu">ggplot</span>()<span class="sc">+</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># highlight the chosen year again</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_tallrect</span>(animint2<span class="sc">::</span><span class="fu">aes</span>(</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">xmin=</span>day_of_year<span class="dv">-1</span><span class="sc">/</span><span class="dv">2</span>, <span class="at">xmax=</span>day_of_year<span class="sc">+</span><span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>),</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">clickSelects=</span><span class="st">"day_of_year"</span>,</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">data=</span>(longdep), <span class="at">alpha=</span><span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>)<span class="sc">+</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a> animint2<span class="sc">::</span><span class="fu">geom_line</span>(animint2<span class="sc">::</span><span class="fu">aes</span>(</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>    day_of_year,percentage,<span class="at">group=</span>quantile,<span class="at">color=</span>quantile),</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">clickSelects=</span><span class="fu">c</span>(<span class="st">"year"</span>,<span class="st">"quantile"</span>), <span class="co">#use selection to choose the year.</span></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>     <span class="at">showSelected=</span><span class="fu">c</span>( <span class="st">"year"</span>), <span class="co">#only show the selected year</span></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">data=</span>(longdep), <span class="at">size=</span><span class="dv">4</span>, <span class="at">alpha=</span><span class="dv">3</span><span class="sc">/</span><span class="dv">5</span>)<span class="sc">+</span></span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Day of year"</span>)<span class="sc">+</span></span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Percentage"</span>)</span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a><span class="fu">animint</span>(plot_QER)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p></p>
<div id="unnamedchunk25"></div>
<script>var unnamedchunk25 = new animint("#unnamedchunk25", "unnamedchunk25/plot.json");</script>
</div>
</div>
</section>
<section id="objective-2-plot-the-temperature-for-chosen-day-t-of-a-given-year" class="level2">
<h2 class="anchored" data-anchor-id="objective-2-plot-the-temperature-for-chosen-day-t-of-a-given-year">Objective 2 : plot the temperature for chosen day t of a given year</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- palette and limits ---</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>pal <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"black"</span>,<span class="st">"#67001f"</span>,<span class="st">'#d73027'</span>,<span class="st">'#f46d43'</span>,<span class="st">'#fdae61'</span>,<span class="st">'#fee090'</span>,</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>         <span class="st">'#ffffbf'</span>,<span class="st">'#e0f3f8'</span>,<span class="st">'#abd9e9'</span>,<span class="st">'#74add1'</span>,<span class="st">'#4575b4'</span>,<span class="st">'#313695'</span>)</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>mm <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">36</span>)</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a><span class="co"># be careful, this is heavy data</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>summers_small <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">aggregate</span>(summers, <span class="at">fact =</span> <span class="dv">1</span>, <span class="at">fun =</span> mean)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: [aggregate] all values in argument 'fact' are 1, nothing to do</code></pre>
</div>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 1. Raster data prepared for ggplot/animint2 ---</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract one value per cell per date -&gt; convert to data.frame</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a><span class="co"># summers is a SpatRaster with layers named as dates</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>map_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(summers_small, <span class="at">xy =</span> <span class="cn">TRUE</span>, <span class="at">na.rm =</span> <span class="cn">FALSE</span>)</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>map_df <span class="ot">&lt;-</span> tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(map_df, <span class="sc">-</span><span class="fu">c</span>(x,y),</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>                              <span class="at">names_to =</span> <span class="st">"t"</span>,</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>                              <span class="at">values_to =</span> <span class="st">"temperature"</span>)</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>map_df<span class="sc">$</span>t <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(map_df<span class="sc">$</span>t)</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>map_df<span class="sc">$</span>year <span class="ot">&lt;-</span> lubridate<span class="sc">::</span><span class="fu">year</span>(map_df<span class="sc">$</span>t)</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>map_df<span class="sc">$</span>day_of_year <span class="ot">&lt;-</span> lubridate<span class="sc">::</span><span class="fu">yday</span>(map_df<span class="sc">$</span>t)</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 2. Map plot (left) ---</span></span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>map_plot <span class="ot">&lt;-</span> animint2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>  animint2<span class="sc">::</span><span class="fu">geom_tile</span>(animint2<span class="sc">::</span><span class="fu">aes</span>(x, y, <span class="at">fill =</span> temperature),</span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>            <span class="at">data =</span> map_df,</span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>            <span class="at">showSelected =</span> <span class="fu">c</span>(<span class="st">"year"</span>,<span class="st">"day_of_year"</span>),<span class="at">colour=</span><span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a>  animint2<span class="sc">::</span><span class="fu">ggtitle</span>(<span class="st">"Date t (selected)"</span>)<span class="sc">+</span></span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a>  animint2<span class="sc">::</span><span class="fu">scale_fill_gradientn</span>(<span class="at">colors =</span> <span class="fu">rev</span>(pal),</span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a>                       <span class="at">na.value =</span> <span class="st">"transparent"</span>,</span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a>                       <span class="at">limits =</span> mm) <span class="sc">+</span></span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a>  animint2<span class="sc">::</span><span class="fu">coord_equal</span>() <span class="sc">+</span></span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a>  animint2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">fill =</span> <span class="st">"temperature"</span>)<span class="sc">+</span><span class="fu">theme_bw</span>()</span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a><span class="fu">animint</span>(map_plot)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p></p>
<div id="unnamedchunk26"></div>
<script>var unnamedchunk26 = new animint("#unnamedchunk26", "unnamedchunk26/plot.json");</script>
</div>
</div>
</section>
<section id="objective-3-plot-together-the-map-of-temperature-at-a-day-highlighting-that-day-on-my-first-plot" class="level2">
<h2 class="anchored" data-anchor-id="objective-3-plot-together-the-map-of-temperature-at-a-day-highlighting-that-day-on-my-first-plot">Objective 3 : plot together the map of temperature at a day, highlighting that day on my first plot</h2>
<p>Can take a while, because the dataframe for plotting is large. We have used shared variables names, so selecting from (year,day_of_year) has the same meaning in both graphs.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>animint2<span class="sc">::</span><span class="fu">animint</span>(plot_QER,map_plot, <span class="at">first =</span> <span class="fu">list</span>(<span class="at">year =</span> <span class="fu">c</span>(<span class="dv">2003</span>), <span class="at">day_of_year =</span> <span class="fu">c</span>(<span class="dv">200</span>)))</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p></p>
<div id="unnamedchunk27"></div>
<script>var unnamedchunk27 = new animint("#unnamedchunk27", "unnamedchunk27/plot.json");</script>
</div>
</div>
</section>
<section id="objective-4-show-maps-at-different-time-steps-t-1-t-and-t1-to-show-temporal-evolution" class="level2">
<h2 class="anchored" data-anchor-id="objective-4-show-maps-at-different-time-steps-t-1-t-and-t1-to-show-temporal-evolution">Objective 4 : Show maps at different time steps : t-1, t and t+1, to show temporal evolution</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Map t-1</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>map_t_minus1 <span class="ot">&lt;-</span> animint2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  animint2<span class="sc">::</span><span class="fu">geom_tile</span>(</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>    animint2<span class="sc">::</span><span class="fu">aes</span>(x, y, <span class="at">fill =</span> temperature),</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> map_df <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">day_of_year =</span> day_of_year <span class="sc">+</span> <span class="dv">1</span>),</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">showSelected =</span> <span class="fu">c</span>(<span class="st">"year"</span>, <span class="st">"day_of_year"</span>),</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fl">0.4</span>,</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">colour =</span> <span class="cn">NA</span></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"t-1"</span>) <span class="sc">+</span></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>  animint2<span class="sc">::</span><span class="fu">scale_fill_gradientn</span>(<span class="at">colors =</span> <span class="fu">rev</span>(pal),</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>                                <span class="at">na.value =</span> <span class="st">"transparent"</span>,</span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>                                <span class="at">limits =</span> mm) <span class="sc">+</span></span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>  animint2<span class="sc">::</span><span class="fu">coord_equal</span>() <span class="sc">+</span></span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Map t</span></span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>map_t <span class="ot">&lt;-</span> animint2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>  animint2<span class="sc">::</span><span class="fu">geom_tile</span>(</span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a>    animint2<span class="sc">::</span><span class="fu">aes</span>(x, y, <span class="at">fill =</span> temperature),</span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> map_df,</span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">showSelected =</span> <span class="fu">c</span>(<span class="st">"year"</span>, <span class="st">"day_of_year"</span>),</span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="dv">1</span>,</span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">colour =</span> <span class="cn">NA</span></span>
<span id="cb44-25"><a href="#cb44-25" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb44-26"><a href="#cb44-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"t"</span>) <span class="sc">+</span></span>
<span id="cb44-27"><a href="#cb44-27" aria-hidden="true" tabindex="-1"></a>  animint2<span class="sc">::</span><span class="fu">scale_fill_gradientn</span>(<span class="at">colors =</span> <span class="fu">rev</span>(pal),</span>
<span id="cb44-28"><a href="#cb44-28" aria-hidden="true" tabindex="-1"></a>                                <span class="at">na.value =</span> <span class="st">"transparent"</span>,</span>
<span id="cb44-29"><a href="#cb44-29" aria-hidden="true" tabindex="-1"></a>                                <span class="at">limits =</span> mm) <span class="sc">+</span></span>
<span id="cb44-30"><a href="#cb44-30" aria-hidden="true" tabindex="-1"></a>  animint2<span class="sc">::</span><span class="fu">coord_equal</span>() <span class="sc">+</span></span>
<span id="cb44-31"><a href="#cb44-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb44-32"><a href="#cb44-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-33"><a href="#cb44-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Map t+1</span></span>
<span id="cb44-34"><a href="#cb44-34" aria-hidden="true" tabindex="-1"></a>map_t_plus1 <span class="ot">&lt;-</span> animint2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb44-35"><a href="#cb44-35" aria-hidden="true" tabindex="-1"></a>  animint2<span class="sc">::</span><span class="fu">geom_tile</span>(</span>
<span id="cb44-36"><a href="#cb44-36" aria-hidden="true" tabindex="-1"></a>    animint2<span class="sc">::</span><span class="fu">aes</span>(x, y, <span class="at">fill =</span> temperature),</span>
<span id="cb44-37"><a href="#cb44-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> map_df <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">day_of_year =</span> day_of_year <span class="sc">-</span> <span class="dv">1</span>),</span>
<span id="cb44-38"><a href="#cb44-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">showSelected =</span> <span class="fu">c</span>(<span class="st">"year"</span>, <span class="st">"day_of_year"</span>),</span>
<span id="cb44-39"><a href="#cb44-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fl">0.4</span>,</span>
<span id="cb44-40"><a href="#cb44-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">colour =</span> <span class="cn">NA</span></span>
<span id="cb44-41"><a href="#cb44-41" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb44-42"><a href="#cb44-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"t+1"</span>) <span class="sc">+</span></span>
<span id="cb44-43"><a href="#cb44-43" aria-hidden="true" tabindex="-1"></a>  animint2<span class="sc">::</span><span class="fu">scale_fill_gradientn</span>(<span class="at">colors =</span> <span class="fu">rev</span>(pal),</span>
<span id="cb44-44"><a href="#cb44-44" aria-hidden="true" tabindex="-1"></a>                                <span class="at">na.value =</span> <span class="st">"transparent"</span>,</span>
<span id="cb44-45"><a href="#cb44-45" aria-hidden="true" tabindex="-1"></a>                                <span class="at">limits =</span> mm) <span class="sc">+</span></span>
<span id="cb44-46"><a href="#cb44-46" aria-hidden="true" tabindex="-1"></a>  animint2<span class="sc">::</span><span class="fu">coord_equal</span>() <span class="sc">+</span></span>
<span id="cb44-47"><a href="#cb44-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb44-48"><a href="#cb44-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-49"><a href="#cb44-49" aria-hidden="true" tabindex="-1"></a><span class="fu">animint</span>(map_t_minus1,map_t,map_t_plus1)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p></p>
<div id="unnamedchunk28"></div>
<script>var unnamedchunk28 = new animint("#unnamedchunk28", "unnamedchunk28/plot.json");</script>
</div>
</div>
</section>
<section id="final-objective" class="level2">
<h2 class="anchored" data-anchor-id="final-objective">Final objective</h2>
<p>Put everything togeteher I wanted a specific layout but nothing worked. It does not give an error, but does not work anyway…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>animint2<span class="sc">::</span><span class="fu">animint</span>(map_t_minus1,map_t,map_t_plus1,plot_QER, <span class="at">first =</span> <span class="fu">list</span>(<span class="at">year =</span> <span class="fu">c</span>(<span class="dv">2003</span>), <span class="at">day_of_year =</span> <span class="fu">c</span>(<span class="dv">200</span>)),<span class="at">arrange =</span> <span class="fu">list</span>(</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">top_row =</span> <span class="fu">c</span>(<span class="st">"map_t_minus1"</span>, <span class="st">"map_t"</span>, <span class="st">"map_t_plus1"</span>),  <span class="co"># top row</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">bottom_row   =</span> <span class="st">"plot_QER"</span>                               <span class="co"># bottom row</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>  ))</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p></p>
<div id="unnamedchunk29"></div>
<script>var unnamedchunk29 = new animint("#unnamedchunk29", "unnamedchunk29/plot.json");</script>
</div>
</div>
</section>
<section id="final-final-objective-add-facets-to-make-it-pretty" class="level2">
<h2 class="anchored" data-anchor-id="final-final-objective-add-facets-to-make-it-pretty">Final Final Objective : add facets to make it pretty</h2>
<p>Many thanks to Blanche who did not let me leave the room with an ugly plot.</p>
<p>Helper functions add_facets add a column to a dataframe, allowing us to make a facet name. We choose to only put a top name for the date.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>add_facets <span class="ot">&lt;-</span> <span class="cf">function</span>(df, top){</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(df,</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>             <span class="at">top=</span><span class="fu">factor</span>(top, <span class="fu">c</span>(<span class="st">"t-1"</span>, <span class="st">"t"</span>, <span class="st">"t+1"</span>)))</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>facet_left  <span class="ot">&lt;-</span> <span class="cf">function</span>(df) <span class="fu">add_facets</span>(df, <span class="st">"t-1"</span>)</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>facet_middle <span class="ot">&lt;-</span> <span class="cf">function</span>(df) <span class="fu">add_facets</span>(df, <span class="st">"t"</span>)</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>facet_right  <span class="ot">&lt;-</span> <span class="cf">function</span>(df) <span class="fu">add_facets</span>(df, <span class="st">"t+1"</span>)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Map t-1</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>map_t <span class="ot">&lt;-</span> animint2<span class="sc">::</span><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>  animint2<span class="sc">::</span><span class="fu">geom_tile</span>(</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>    animint2<span class="sc">::</span><span class="fu">aes</span>(x, y, <span class="at">fill =</span> temperature),</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> <span class="fu">facet_left</span>(map_df <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">day_of_year =</span> day_of_year <span class="sc">+</span> <span class="dv">1</span>)),</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">showSelected =</span> <span class="fu">c</span>(<span class="st">"year"</span>, <span class="st">"day_of_year"</span>),</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fl">0.4</span>,</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">colour =</span> <span class="cn">NA</span></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>  animint2<span class="sc">::</span><span class="fu">scale_fill_gradientn</span>(<span class="at">colors =</span> <span class="fu">rev</span>(pal),</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>                                <span class="at">na.value =</span> <span class="st">"transparent"</span>,</span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>                                <span class="at">limits =</span> mm) <span class="sc">+</span></span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>  animint2<span class="sc">::</span><span class="fu">coord_equal</span>() <span class="sc">+</span></span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a>  animint2<span class="sc">::</span><span class="fu">geom_tile</span>(</span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a>    animint2<span class="sc">::</span><span class="fu">aes</span>(x, y, <span class="at">fill =</span> temperature),</span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> <span class="fu">facet_middle</span>(map_df),</span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">showSelected =</span> <span class="fu">c</span>(<span class="st">"year"</span>, <span class="st">"day_of_year"</span>),</span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="dv">1</span>,</span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">colour =</span> <span class="cn">NA</span></span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a>  animint2<span class="sc">::</span><span class="fu">scale_fill_gradientn</span>(<span class="at">colors =</span> <span class="fu">rev</span>(pal),</span>
<span id="cb47-24"><a href="#cb47-24" aria-hidden="true" tabindex="-1"></a>                                <span class="at">na.value =</span> <span class="st">"transparent"</span>,</span>
<span id="cb47-25"><a href="#cb47-25" aria-hidden="true" tabindex="-1"></a>                                <span class="at">limits =</span> mm) <span class="sc">+</span></span>
<span id="cb47-26"><a href="#cb47-26" aria-hidden="true" tabindex="-1"></a>  animint2<span class="sc">::</span><span class="fu">coord_equal</span>() <span class="sc">+</span></span>
<span id="cb47-27"><a href="#cb47-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb47-28"><a href="#cb47-28" aria-hidden="true" tabindex="-1"></a>  animint2<span class="sc">::</span><span class="fu">geom_tile</span>(</span>
<span id="cb47-29"><a href="#cb47-29" aria-hidden="true" tabindex="-1"></a>    animint2<span class="sc">::</span><span class="fu">aes</span>(x, y, <span class="at">fill =</span> temperature),</span>
<span id="cb47-30"><a href="#cb47-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> <span class="fu">facet_right</span>(map_df <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">day_of_year =</span> day_of_year <span class="sc">-</span> <span class="dv">1</span>)),</span>
<span id="cb47-31"><a href="#cb47-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">showSelected =</span> <span class="fu">c</span>(<span class="st">"year"</span>, <span class="st">"day_of_year"</span>),</span>
<span id="cb47-32"><a href="#cb47-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fl">0.4</span>,</span>
<span id="cb47-33"><a href="#cb47-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">colour =</span> <span class="cn">NA</span></span>
<span id="cb47-34"><a href="#cb47-34" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb47-35"><a href="#cb47-35" aria-hidden="true" tabindex="-1"></a>  animint2<span class="sc">::</span><span class="fu">scale_fill_gradientn</span>(<span class="at">colors =</span> <span class="fu">rev</span>(pal),</span>
<span id="cb47-36"><a href="#cb47-36" aria-hidden="true" tabindex="-1"></a>                                <span class="at">na.value =</span> <span class="st">"transparent"</span>,</span>
<span id="cb47-37"><a href="#cb47-37" aria-hidden="true" tabindex="-1"></a>                                <span class="at">limits =</span> mm) <span class="sc">+</span></span>
<span id="cb47-38"><a href="#cb47-38" aria-hidden="true" tabindex="-1"></a>  animint2<span class="sc">::</span><span class="fu">coord_equal</span>() <span class="sc">+</span></span>
<span id="cb47-39"><a href="#cb47-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb47-40"><a href="#cb47-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb47-41"><a href="#cb47-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>top)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Scale for 'fill' is already present. Adding another scale for 'fill', which
will replace the existing scale.
Scale for 'fill' is already present. Adding another scale for 'fill', which
will replace the existing scale.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>map_t</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="animint_files/figure-html/unnamed-chunk-31-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">animint</span>(map_t,plot_QER, <span class="at">first =</span> <span class="fu">list</span>(<span class="at">year =</span> <span class="fu">c</span>(<span class="dv">2003</span>), <span class="at">day_of_year =</span> <span class="fu">c</span>(<span class="dv">200</span>)))</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p></p>
<div id="unnamedchunk31"></div>
<script>var unnamedchunk31 = new animint("#unnamedchunk31", "unnamedchunk31/plot.json");</script>
</div>
</div>
</section>
</section>
<section id="saving-your-work" class="level1">
<h1>SAVING YOUR WORK</h1>
<section id="option-1-in-rmd-and-qmd" class="level2">
<h2 class="anchored" data-anchor-id="option-1-in-rmd-and-qmd">Option 1: in rmd and qmd</h2>
<p>Output directory auto-generated, be careful use only one animint per named code chunk.</p>
</section>
<section id="option-2-html" class="level2">
<h2 class="anchored" data-anchor-id="option-2-html">Option 2: html</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">animint2dir</span>(<span class="fu">animint</span>(plot_both),</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>            <span class="at">out.dir =</span> <span class="st">"myplot"</span>, </span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">open.browser =</span> <span class="cn">FALSE</span>)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The plot can be viewed with index.html. If the web page is blank, configure your browser to allow execution of local JavaScript code, as explained on the <a href="https://github.com/tdhock/animint2/wiki/FAQ#web-browser-on-local-indexhtml-file-is-blank">FAQ</a>.</p>
</section>
<section id="section" class="level2">
<h2 class="anchored" data-anchor-id="section"></h2>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copié");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copié");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>